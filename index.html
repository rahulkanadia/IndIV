<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IndIV</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <link rel="stylesheet" href="frontend/global.css">
    
    <link rel="stylesheet" href="frontend/components/charts/chart-dashboard/chart-dashboard.css">
    <link rel="stylesheet" href="frontend/components/market-grid/market-grid.css">
    <link rel="stylesheet" href="frontend/components/tables/sd-table/sd-table.css">
    <link rel="stylesheet" href="frontend/components/tables/greeks-table/greeks-table.css">
    <link rel="stylesheet" href="frontend/components/pcr-widget/pcr-widget.css">
</head>
<body>
    <header>
        <div class="header-left" id="header-left-content"></div>
        <div class="header-center" id="header-center-content"></div>
        <div class="header-right">
            <a href="#" class="help-link">How to use?</a>
            <div class="last-update" id="last-update-time">last updated: --:--:--</div>
        </div>
    </header>

    <div class="dashboard-container">
        <div class="left-panel">
            <div id="weekly-grid-container"></div>
            <div id="main-chart-dashboard"></div>
            <div id="monthly-grid-container"></div>
        </div>

        <div class="right-panel">
            <div class="split-row">
                <div class="split-pcr">
                    <div id="pcr-container" style="height:100%; width:100%;"></div>
                </div>
                <div class="split-sd">
                    <div id="sd-table-container" style="height:100%; width:100%;"></div>
                </div>
            </div>
            <div id="greeks-table-container"></div>
            <div id="quote-box-container">
                "The market is a device for transferring money from the impatient to the patient." — Warren Buffett
            </div>
        </div>
    </div>

<script type="module">
    import { DataManager } from './frontend/lib/DataManager.js';
    import { renderMarketGrid } from './frontend/components/market-grid/market-grid.js';
    import { renderChartDashboard } from './frontend/components/charts/chart-dashboard/chart-dashboard.js';
    import { renderSDTable } from './frontend/components/tables/sd-table/sd-table.js';
    // Note: We are using the OLD greeks table for now until we update it in the next step
    import { renderGreeksTable } from './frontend/components/tables/greeks-table/greeks-table.js';
    import { renderPCRSpark } from './frontend/components/pcr-widget/pcr-widget.js';

    const manager = new DataManager();

     function renderHeaderCluster(data) {
        const leftContainer = document.getElementById('header-left-content');
        const centerContainer = document.getElementById('header-center-content');
        if(!leftContainer || !centerContainer) return;

        // --- UPDATED THIS BLOCK ---
        const spot = data.header ? data.header.spot : 0;
        const fut = data.header ? data.header.futures : 0; 
        const futChg = data.header ? data.header.futuresChange : { txt: '-', cls: 'neutral' };
        // --------------------------

        const isLive = manager.source === 'LIVE';
        
        leftContainer.innerHTML = `
            <div class="brand-title">IndIV</div>
            <div class="neon-container">
                <span class="neon-line-1">DATA SOURCE</span>
                <span class="neon-status ${isLive ? 'status-open' : 'status-closed'}">
                    ${isLive ? 'LIVE' : 'MOCK'}
                </span>
            </div>
        `;

        centerContainer.innerHTML = `
            <div class="price-display-group">
                <div class="price-label">Spot</div>
                <div class="price-data-row val-up">
                    <span>${spot.toLocaleString()}</span>
                </div>
            </div>

            <div class="search-pill"><span class="search-text">NIFTY 50</span></div>

            <div class="price-display-group align-left">
                <div class="price-label">Futures</div>
                <div class="price-data-row ${futChg.cls}">
                    <span>${fut.toLocaleString()}</span>
                    <span style="font-size:12px; margin-left:5px;">${futChg.txt}</span>
                </div>
            </div>
        `;
    }


    async function init() {
        console.log("Initializing...");
        
        // 1. FETCH
        const { data, source, logs } = await manager.fetch();
        
        // 2. LOGGING (As per your rule: List problems in text box)
        const quoteBox = document.getElementById('quote-box-container');
        if (quoteBox) {
            if (source === 'MOCK') {
                quoteBox.style.color = '#FF5252';
                quoteBox.innerHTML = `⚠️ ${logs[0]} | ${logs[1] || ''}`;
            } else {
                quoteBox.style.color = '#00E676';
                quoteBox.innerHTML = `✅ Live Connection Active. Last Sync: ${new Date().toLocaleTimeString()}`;
            }
        }

        // 3. RENDER
        renderHeaderCluster(data);
        document.getElementById('last-update-time').innerText = `updated: ${new Date().toLocaleTimeString()}`;

        renderMarketGrid('weekly-grid-container', 'WEEKLY', data.gridWeekly, 't-week');
        renderMarketGrid('monthly-grid-container', 'MONTHLY', data.gridMonthly, 't-month');

// CORRECTION: Pass the root 'data' object, as it contains {intraday, term...} direct keys
renderChartDashboard('main-chart-dashboard', data);

        renderPCRSpark('pcr-container', data.pcr);
        renderSDTable('sd-table-container', data); // This might look empty if backend doesn't send SD yet
        
        // Greeks Table (Currently still generates its own random data, so it is safe)
        renderGreeksTable('greeks-table-container', data);
    }

    init();
</script>

</body>
</html>
